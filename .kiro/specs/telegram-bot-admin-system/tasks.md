# Implementation Plan: Telegram Bot Admin System

## Overview

Обновление существующего Telegram-бота с добавлением полноценной системы администрирования, магазина товаров и улучшенной структуры базы данных. Реализация использует Python с библиотекой pyTelegramBotAPI и SQLite для хранения данных.

## Tasks

- [x] 1. Обновить структуру базы данных и создать вспомогательные функции
  - Обновить функцию init_database() для создания правильной структуры таблиц users и transactions
  - Создать функции для работы с базой данных: get_db_connection(), register_user(), get_user_by_username()
  - Добавить функции для работы с транзакциями: add_transaction(), update_user_balance()
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 2. Реализовать систему проверки прав администратора
  - Создать функцию is_admin() для проверки прав пользователя
  - Реализовать декоратор admin_required для защиты административных команд
  - Добавить обработку ошибок доступа с понятными сообщениями
  - _Requirements: 1.2, 1.3, 2.6, 3.5, 8.2_

- [x] 3. Реализовать автоматическую регистрацию пользователей
  - [x] 3.1 Создать обработчик всех сообщений для автоматической регистрации
    - Реализовать middleware для проверки существования пользователя по Telegram ID
    - Добавить создание новых пользователей с полями: id, username, first_name, balance=0, is_admin=FALSE
    - Обеспечить прозрачность процесса регистрации без дополнительных сообщений
    - _Requirements: 6.1, 6.2, 6.3, 6.5_
  
  - [x] 3.2 Написать property test для автоматической регистрации
    - **Property 7: User registration idempotence**
    - **Validates: Requirements 6.2, 6.4**

- [x] 4. Реализовать команду /admin для панели администратора
  - [x] 4.1 Создать обработчик команды /admin с точным форматом вывода
    - Реализовать проверку прав администратора через декоратор
    - Добавить функцию get_users_count() для получения статистики
    - Реализовать точный формат сообщения: "Админ-панель:\n/add_points @username [число] - начислить очки\n/add_admin @username - добавить администратора\nВсего пользователей: [число]"
    - _Requirements: 1.1, 1.2, 1.4_
  
  - [x] 4.2 Написать property test для проверки авторизации
    - **Property 1: Authorization consistency**
    - **Validates: Requirements 1.2, 2.6, 3.5, 8.2**
  
  - [x] 4.3 Написать property test для точности подсчета пользователей
    - **Property 4: User count accuracy**
    - **Validates: Requirements 1.4**

- [ ] 5. Реализовать команду /add_points для начисления очков
  - [x] 5.1 Создать обработчик команды с парсингом аргументов
    - Реализовать парсинг формата "/add_points @username [число]"
    - Добавить валидацию входных данных и поиск пользователя по username
    - Реализовать обновление баланса и создание транзакции типа 'add'
    - Добавить отправку подтверждения в формате "Пользователю @username начислено [число] очков. Новый баланс: [новый_баланс]"
    - _Requirements: 2.1, 2.2, 2.3_
  
  - [x] 5.2 Добавить обработку ошибок для команды /add_points
    - Реализовать обработку ошибки "пользователь не найден"
    - Добавить обработку неверного формата команды с инструкциями
    - Обеспечить информативные сообщения об ошибках
    - _Requirements: 2.4, 2.5, 8.4, 8.5_
  
  - [x] 5.3 Написать property test для арифметики баланса
    - **Property 2: Balance arithmetic correctness**
    - **Validates: Requirements 2.1**
  
  - [x] 5.4 Написать property test для логирования транзакций
    - **Property 3: Transaction logging completeness**
    - **Validates: Requirements 2.2**

- [ ] 6. Реализовать команду /add_admin для назначения администраторов
  - [x] 6.1 Создать обработчик команды /add_admin
    - Реализовать парсинг формата "/add_admin @username"
    - Добавить поиск пользователя и обновление флага is_admin = TRUE
    - Реализовать отправку подтверждения в формате "Пользователь @username теперь администратор"
    - Добавить обработку ошибки "пользователь не найден"
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 6.2 Написать property test для персистентности статуса администратора
    - **Property 5: Admin status persistence**
    - **Validates: Requirements 3.1, 3.4**

- [ ] 7. Реализовать систему магазина
  - [x] 7.1 Создать команду /shop для отображения товаров
    - Реализовать обработчик команды /shop для всех пользователей
    - Добавить точный формат сообщения: "Магазин:\n1. Сообщение админу - 10 очков\nДля покупки введите /buy_contact"
    - Обеспечить отображение всех доступных товаров с ценами
    - _Requirements: 4.1, 4.2, 4.3_
  
  - [x] 7.2 Создать команду /buy_contact для покупки товаров
    - Реализовать проверку баланса пользователя (минимум 10 очков)
    - Добавить списание 10 очков и создание транзакции типа 'buy'
    - Реализовать отправку подтверждения пользователю: "Вы купили контакт. Администратор свяжется с вами."
    - Добавить уведомление администраторов: "Пользователь @username купил контакт. Его баланс: [новый_баланс] очков"
    - Реализовать обработку ошибки недостаточного баланса с указанием текущего баланса
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_
  
  - [x] 7.3 Написать property test для валидации покупок
    - **Property 6: Purchase balance validation**
    - **Validates: Requirements 5.1, 5.2**
  
  - [x] 7.4 Написать property test для доступности магазина
    - **Property 10: Shop accessibility universality**
    - **Validates: Requirements 4.2, 4.3**

- [x] 8. Checkpoint - Проверить основной функционал
  - Убедиться что все команды работают корректно
  - Проверить автоматическую регистрацию пользователей
  - Протестировать систему прав администратора
  - Убедиться в корректности работы магазина
  - Задать вопросы пользователю при возникновении проблем

- [ ] 9. Обновить существующие команды для совместимости
  - [x] 9.1 Обновить команду /start для новой системы регистрации
    - Интегрировать с автоматической регистрацией пользователей
    - Обеспечить совместимость с существующим функционалом
    - _Requirements: 6.4, 8.7_
  
  - [x] 9.2 Обновить команду /balance для новой структуры БД
    - Адаптировать для работы с новой таблицей users
    - Обеспечить корректное отображение баланса
    - _Requirements: 8.7_

- [ ] 10. Добавить комплексные property tests
  - [x] 10.1 Написать property test для обработки ошибок
    - **Property 8: Error handling consistency**
    - **Validates: Requirements 2.4, 2.5, 5.6, 8.3, 8.4, 8.5**
  
  - [x] 10.2 Написать property test для целостности базы данных
    - **Property 9: Database integrity preservation**
    - **Validates: Requirements 7.3, 8.6**

- [ ] 11. Добавить unit tests для конкретных случаев
  - [-] 11.1 Написать unit tests для форматов сообщений
    - Тестировать точные форматы команд /admin, /shop, подтверждений
    - Проверить корректность отображения статистики и товаров
    - _Requirements: 1.1, 4.1, 2.3, 3.2, 5.4, 5.5_
  
  - [~] 11.2 Написать unit tests для граничных случаев
    - Тестировать нулевые балансы, максимальные значения
    - Проверить обработку специальных символов в username
    - Тестировать edge cases для транзакций
    - _Requirements: 2.1, 5.1, 6.3_
  
  - [~] 11.3 Написать integration tests для полного цикла
    - Тестировать полный цикл: регистрация → начисление → покупка
    - Проверить взаимодействие с существующей архитектурой
    - Тестировать уведомления администраторов
    - _Requirements: 6.1, 2.1, 5.1, 5.5_

- [~] 12. Final checkpoint - Убедиться что все тесты проходят
  - Запустить все unit tests и property tests
  - Проверить покрытие кода тестами
  - Убедиться в отсутствии регрессий в существующем функционале
  - Задать вопросы пользователю при возникновении проблем

## Notes

- Все задачи являются обязательными для комплексного подхода к разработке
- Каждая задача ссылается на конкретные требования для отслеживания
- Checkpoints обеспечивают инкрементальную валидацию
- Property tests проверяют универсальные свойства корректности
- Unit tests проверяют конкретные примеры и граничные случаи
- Используется библиотека Hypothesis для property-based testing с минимум 100 итерациями на тест