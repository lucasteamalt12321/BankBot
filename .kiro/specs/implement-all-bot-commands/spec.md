# Спецификация: Реализация всех команд Telegram-бота

## Цель
Реализовать все заявленные команды Telegram-бота согласно предоставленному списку, включая недостающие конфигурационные команды и расширенные административные функции.

## Текущее состояние

### Уже реализованные команды

#### Основные команды ✅
- `/start` - регистрация и приветствие
- `/balance` - проверить баланс
- `/history` - история транзакций
- `/profile` - профиль пользователя
- `/stats` - персональная статистика

#### Магазин ✅
- `/shop` - просмотр магазина
- `/buy <номер>` - купить товар
- `/buy_1` до `/buy_8` - быстрая покупка
- `/buy_contact` - связь с админом
- `/inventory` - инвентарь

#### Мини-игры ✅
- `/games` - информация о играх
- `/play` - создать игру
- `/join` - присоединиться
- `/startgame` - начать игру
- `/turn` - сделать ход

#### D&D система ✅
- `/dnd` - информация
- `/dnd_create` - создать сессию
- `/dnd_join` - присоединиться
- `/dnd_roll` - бросок кубиков
- `/dnd_sessions` - список сессий

#### Мотивация ✅
- `/daily`, `/bonus` - ежедневный бонус
- `/challenges` - задания
- `/streak` - статистика серий

#### Достижения ✅
- `/achievements` - достижения
- `/notifications` - уведомления
- `/notifications_clear` - очистить уведомления

#### Социальные ✅
- `/friends` - список друзей
- `/friend_add` - добавить друга
- `/friend_accept` - принять запрос
- `/gift` - отправить подарок
- `/clan` - информация о клане
- `/clan_create` - создать клан
- `/clan_join` - вступить в клан
- `/clan_leave` - покинуть клан

#### Базовые админ-команды ✅
- `/admin` - панель администратора
- `/add_points` - начислить очки
- `/add_admin` - назначить администратора
- `/admin_stats` - статистика системы
- `/admin_adjust` - скорректировать баланс
- `/admin_addcoins` - добавить монеты
- `/admin_removecoins` - снять монеты
- `/admin_merge` - объединить аккаунты
- `/admin_transactions` - транзакции пользователя
- `/admin_balances` - топ по балансу
- `/admin_users` - список пользователей
- `/admin_rates` - курсы валют
- `/admin_rate` - установить курс
- `/admin_cleanup` - очистка БД

#### Админ: Магазин ✅
- `/admin_shop_add` - добавить товар
- `/admin_shop_edit` - редактировать товар
- `/add_item` - добавить товар (расширенная)

#### Админ: Игры ✅
- `/admin_games_stats` - статистика игр
- `/admin_reset_game` - сбросить игру
- `/admin_ban_player` - забанить игрока

#### Админ: Система ✅
- `/admin_health` - здоровье системы
- `/admin_errors` - журнал ошибок
- `/admin_backup` - создать бэкап

#### Расширенные админ-команды ✅
- `/parsing_stats` - статистика парсинга
- `/broadcast` - рассылка
- `/user_stats` - статистика пользователя

#### Фоновые задачи ✅
- `/admin_background_status` - статус задач
- `/admin_background_health` - здоровье системы
- `/admin_background_restart` - перезапуск

#### Конфигурация парсинга (частично) ⚠️
- `/admin_parsing_reload` - перезагрузить конфигурацию ✅
- `/admin_parsing_config` - показать конфигурацию ✅

### Недостающие команды для реализации

#### Конфигурационные команды ❌
1. `/reload_config` - перезагрузить конфигурацию без перезапуска
2. `/config_status` - статус конфигурации
3. `/list_parsing_rules` - список правил парсинга
4. `/add_parsing_rule` - добавить правило парсинга
5. `/update_parsing_rule` - обновить правило
6. `/export_config` - экспорт конфигурации
7. `/import_config` - импорт конфигурации
8. `/backup_config` - создать бэкап конфигурации
9. `/restore_config` - восстановить из бэкапа
10. `/list_backups` - список бэкапов
11. `/validate_config` - валидация конфигурации

## Требования

### Функциональные требования

#### FR-1: Конфигурационные команды
- Все конфигурационные команды должны быть доступны только администраторам
- Команды должны работать с системой ConfigManager
- Должна быть валидация входных данных
- Должны быть информативные сообщения об ошибках

#### FR-2: Интеграция с существующей системой
- Использовать существующий AdminSystem для проверки прав
- Использовать ConfigManager из core/managers/config_manager.py
- Следовать существующему стилю кода и форматированию сообщений

#### FR-3: Безопасность
- Все административные команды требуют проверки прав
- Валидация всех входных параметров
- Логирование всех административных действий

### Нефункциональные требования

#### NFR-1: Производительность
- Команды должны выполняться быстро (< 2 секунд)
- Асинхронная обработка для длительных операций

#### NFR-2: Надежность
- Обработка всех возможных ошибок
- Graceful degradation при недоступности сервисов
- Транзакционность операций с БД

#### NFR-3: Удобство использования
- Понятные сообщения об ошибках
- Примеры использования в справке
- Подтверждение критических операций

## Архитектура

### Компоненты

1. **ConfigurationCommands** (bot/commands/config_commands.py)
   - Уже существует, содержит большинство команд
   - Нужно зарегистрировать команды в bot.py

2. **TelegramBot** (bot/bot.py)
   - Добавить регистрацию конфигурационных команд
   - Создать обертки для команд ConfigurationCommands

3. **ConfigManager** (core/managers/config_manager.py)
   - Уже реализован
   - Предоставляет все необходимые методы

### Поток данных

```
Пользователь -> Telegram -> TelegramBot -> ConfigurationCommands -> ConfigManager -> БД
                                                                                    -> Файлы
```

## Задачи реализации

### Задача 1: Регистрация конфигурационных команд
**Приоритет:** Высокий
**Файл:** bot/bot.py

Добавить регистрацию всех конфигурационных команд в метод `setup_handlers()`:

```python
# Configuration Management Commands (Task 11.2)
CommandHandler("reload_config", self.reload_config_command),
CommandHandler("config_status", self.config_status_command),
CommandHandler("list_parsing_rules", self.list_parsing_rules_command),
CommandHandler("add_parsing_rule", self.add_parsing_rule_command),
CommandHandler("update_parsing_rule", self.update_parsing_rule_command),
CommandHandler("export_config", self.export_config_command),
CommandHandler("import_config", self.import_config_command),
CommandHandler("backup_config", self.backup_config_command),
CommandHandler("restore_config", self.restore_config_command),
CommandHandler("list_backups", self.list_backups_command),
CommandHandler("validate_config", self.validate_config_command),
```

### Задача 2: Создание методов-оберток
**Приоритет:** Высокий
**Файл:** bot/bot.py

Создать методы-обертки для каждой команды, которые будут вызывать соответствующие методы из ConfigurationCommands:

```python
async def reload_config_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обертка для команды /reload_config"""
    await self.config_commands.reload_config_command(update, context)

async def config_status_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обертка для команды /config_status"""
    await self.config_commands.config_status_command(update, context)

# ... и так далее для всех команд
```

### Задача 3: Инициализация ConfigurationCommands
**Приоритет:** Высокий
**Файл:** bot/bot.py

В методе `__init__()` добавить инициализацию ConfigurationCommands:

```python
# Инициализация конфигурационных команд
from bot.commands.config_commands import ConfigurationCommands
self.config_commands = ConfigurationCommands()
```

### Задача 4: Проверка и дополнение ConfigurationCommands
**Приоритет:** Средний
**Файл:** bot/commands/config_commands.py

Проверить, что все методы в ConfigurationCommands:
- Имеют правильную сигнатуру
- Используют AdminManager для проверки прав
- Имеют обработку ошибок
- Логируют действия
- Возвращают информативные сообщения

### Задача 5: Тестирование
**Приоритет:** Средний

Протестировать каждую команду:
1. Проверка прав доступа (не-админ не может использовать)
2. Валидация параметров
3. Успешное выполнение
4. Обработка ошибок
5. Логирование

### Задача 6: Документация
**Приоритет:** Низкий

Обновить документацию:
- Добавить описание всех команд в README
- Обновить примеры использования
- Добавить troubleshooting guide

## Критерии приемки

### AC-1: Все команды зарегистрированы
- Все 11 конфигурационных команд зарегистрированы в bot.py
- Команды отвечают на вызовы пользователей

### AC-2: Проверка прав работает
- Не-администраторы получают сообщение об отказе в доступе
- Администраторы могут использовать все команды

### AC-3: Команды работают корректно
- Каждая команда выполняет свою функцию
- Параметры валидируются
- Ошибки обрабатываются gracefully

### AC-4: Логирование работает
- Все административные действия логируются
- Логи содержат достаточно информации для аудита

### AC-5: Пользовательский опыт
- Сообщения понятны и информативны
- Есть примеры использования
- Ошибки объясняются понятным языком

## Риски и митигация

### Риск 1: ConfigManager не полностью реализован
**Вероятность:** Средняя
**Влияние:** Высокое
**Митигация:** Проверить наличие всех методов в ConfigManager перед началом работы

### Риск 2: Конфликты с существующими командами
**Вероятность:** Низкая
**Влияние:** Среднее
**Митигация:** Проверить уникальность имен команд

### Риск 3: Проблемы с производительностью
**Вероятность:** Низкая
**Влияние:** Среднее
**Митигация:** Использовать асинхронные операции, кэширование

## Зависимости

- ConfigManager должен быть полностью реализован
- AdminSystem должен работать корректно
- База данных должна быть доступна
- Файловая система должна иметь права на запись (для бэкапов)

## Временная оценка

- Задача 1: 30 минут
- Задача 2: 1 час
- Задача 3: 15 минут
- Задача 4: 2 часа
- Задача 5: 2 часа
- Задача 6: 1 час

**Итого:** ~7 часов

## Примечания

- Все команды должны следовать существующему стилю кода
- Использовать structlog для логирования
- Все сообщения должны быть на русском языке
- HTML-форматирование для сообщений Telegram
