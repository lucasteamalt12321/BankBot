# Задачи: Исправление критических проблем проекта

## Фаза 1: Основа (Приоритет 1) - Недели 1-2

### 1. Унификация конфигурации

- [x] 1.1 Создать новый `src/config.py` с Pydantic Settings
  - [x] 1.1.1 Установить pydantic и python-dotenv
  - [x] 1.1.2 Создать класс Settings с валидацией
  - [x] 1.1.3 Добавить поддержку множественных окружений
  - [x] 1.1.4 Написать unit тесты для Settings
  - [x] 1.1.5 Написать property-based тесты для валидации

- [x] 1.2 Добавить deprecation warnings в старые config файлы
  - [x] 1.2.1 Создать `utils/compat.py` с warnings
  - [x] 1.2.2 Обновить `utils/config.py` с deprecation
  - [x] 1.2.3 Обновить `utils/core/config.py` с deprecation

- [x] 1.3 Обновить все импорты конфигурации
  - [x] 1.3.1 Создать скрипт `scripts/fix_config_imports.py`
  - [x] 1.3.2 Запустить скрипт на всех Python файлах
  - [x] 1.3.3 Проверить, что все тесты проходят
  - [x] 1.3.4 Вручную проверить критические файлы

- [x] 1.4 Удалить старые config файлы
  - [x] 1.4.1 Удалить `utils/config.py`
  - [x] 1.4.2 Удалить `utils/core/config.py`
  - [x] 1.4.3 Обновить документацию

### 2. Вынос конфиденциальных данных

- [x] 2.1 Создать `.env.example` с документацией
  - [x] 2.1.1 Добавить все необходимые переменные
  - [x] 2.1.2 Добавить комментарии с описанием
  - [x] 2.1.3 Добавить примеры значений

- [x] 2.2 Добавить ADMIN_TELEGRAM_ID в Settings
  - [x] 2.2.1 Добавить поле в класс Settings
  - [x] 2.2.2 Добавить валидацию
  - [x] 2.2.3 Написать тесты

- [x] 2.3 Заменить хардкод на переменные окружения
  - [x] 2.3.1 Создать скрипт поиска хардкода `scripts/find_hardcoded_ids.py`
  - [x] 2.3.2 Найти все 20+ мест с ID 2091908459
  - [x] 2.3.3 Заменить на `settings.ADMIN_TELEGRAM_ID`
  - [x] 2.3.4 Проверить все тесты

- [x] 2.4 Обновить документацию по развертыванию
  - [x] 2.4.1 Добавить раздел "Environment Variables" в README
  - [x] 2.4.2 Обновить инструкции по установке

### 3. Исправление зависимостей

- [x] 3.1 Создать правильный `requirements.txt`
  - [x] 3.1.1 Собрать все production зависимости
  - [x] 3.1.2 Закрепить версии
  - [x] 3.1.3 Добавить комментарии к группам зависимостей

- [x] 3.2 Создать `requirements-dev.txt`
  - [x] 3.2.1 Переместить тестовые библиотеки
  - [x] 3.2.2 Добавить линтеры и форматтеры
  - [x] 3.2.3 Добавить инструменты разработки

- [x] 3.3 Создать `requirements-docs.txt`
  - [x] 3.3.1 Добавить Sphinx
  - [x] 3.3.2 Добавить темы и расширения

- [x] 3.4 Протестировать установку
  - [x] 3.4.1 Создать чистое виртуальное окружение
  - [x] 3.4.2 Установить зависимости
  - [x] 3.4.3 Запустить бота
  - [x] 3.4.4 Запустить тесты

### 4. Исправление импортов в тестах

- [x] 4.1 Создать compatibility layer
  - [x] 4.1.1 Создать `utils/compat.py`
  - [x] 4.1.2 Добавить re-exports с warnings

- [x] 4.2 Создать скрипт автоматической замены импортов
  - [x] 4.2.1 Создать `scripts/fix_imports.py`
  - [x] 4.2.2 Добавить mapping старых импортов на новые
  - [x] 4.2.3 Протестировать на одном файле

- [x] 4.3 Исправить импорты во всех тестах
  - [x] 4.3.1 Запустить скрипт на tests/
  - [x] 4.3.2 Вручную проверить проблемные файлы
  - [x] 4.3.3 Исправить специфичные случаи

- [x] 4.4 Проверить, что все тесты загружаются
  - [x] 4.4.1 Запустить `pytest --collect-only`
  - [x] 4.4.2 Исправить оставшиеся ошибки
  - [x] 4.4.3 Запустить полный набор тестов

## Фаза 2: Архитектура (Приоритет 2) - Недели 3-5

### 5. Унификация работы с базой данных

- [x] 5.1 Создать базовый репозиторий
  - [x] 5.1.1 Создать `src/repository/base.py`
  - [x] 5.1.2 Реализовать CRUD операции
  - [x] 5.1.3 Написать unit тесты
  - [x] 5.1.4 Написать property-based тесты

- [x] 5.2 Создать UserRepository
  - [x] 5.2.1 Создать `src/repository/user_repository.py`
  - [x] 5.2.2 Реализовать специфичные методы
  - [x] 5.2.3 Написать тесты

- [~] 5.3 Мигрировать прямые SQL запросы
  - [~] 5.3.1 Найти все места с прямым SQL
  - [~] 5.3.2 Заменить на репозитории
  - [~] 5.3.3 Проверить тесты

- [~] 5.4 Пометить simple_db.py как deprecated
  - [~] 5.4.1 Добавить deprecation warning
  - [~] 5.4.2 Обновить документацию
  - [~] 5.4.3 Создать план миграции

### 6. Улучшение обработки ошибок

- [~] 6.1 Создать middleware для обработки ошибок
  - [~] 6.1.1 Создать `bot/middleware/error_handler.py`
  - [~] 6.1.2 Реализовать обработку исключений
  - [~] 6.1.3 Добавить уведомления администратора

- [~] 6.2 Интегрировать middleware в бота
  - [~] 6.2.1 Зарегистрировать middleware
  - [~] 6.2.2 Протестировать на разных типах ошибок

- [~] 6.3 Добавить тесты для обработки ошибок
  - [~] 6.3.1 Unit тесты для middleware
  - [~] 6.3.2 Integration тесты для различных сценариев
  - [~] 6.3.3 Property-based тесты для устойчивости

### 7. Унификация конфигурации парсинга

- [~] 7.1 Создать модель ParsingRule
  - [~] 7.1.1 Добавить модель в `src/models/`
  - [~] 7.1.2 Создать миграцию БД
  - [~] 7.1.3 Написать тесты

- [~] 7.2 Создать ParsingConfigManager
  - [~] 7.2.1 Создать `core/managers/parsing_config_manager.py`
  - [~] 7.2.2 Реализовать API управления
  - [~] 7.2.3 Написать тесты

- [~] 7.3 Мигрировать данные из coefficients.json
  - [~] 7.3.1 Создать скрипт миграции
  - [~] 7.3.2 Запустить миграцию
  - [~] 7.3.3 Проверить данные

- [~] 7.4 Обновить парсеры для использования БД
  - [~] 7.4.1 Обновить все парсеры
  - [~] 7.4.2 Удалить старую конфигурацию
  - [~] 7.4.3 Проверить тесты

### 8. Валидация окружения

- [~] 8.1 Создать StartupValidator
  - [~] 8.1.1 Создать `src/startup_validator.py`
  - [~] 8.1.2 Реализовать проверки
  - [~] 8.1.3 Написать тесты

- [~] 8.2 Интегрировать валидацию в main.py
  - [~] 8.2.1 Добавить вызов при старте
  - [~] 8.2.2 Протестировать с разными конфигурациями

- [~] 8.3 Добавить значения по умолчанию
  - [~] 8.3.1 Определить необязательные параметры
  - [~] 8.3.2 Добавить defaults в Settings
  - [~] 8.3.3 Документировать defaults

### 9. Безопасное завершение процессов

- [~] 9.1 Создать ProcessManager
  - [~] 9.1.1 Создать `src/process_manager.py`
  - [~] 9.1.2 Реализовать PID management
  - [~] 9.1.3 Написать тесты

- [~] 9.2 Реализовать graceful shutdown
  - [~] 9.2.1 Добавить обработку сигналов
  - [~] 9.2.2 Реализовать закрытие ресурсов
  - [~] 9.2.3 Протестировать shutdown

- [~] 9.3 Обновить скрипты запуска
  - [~] 9.3.1 Обновить `run_bot.py`
  - [~] 9.3.2 Удалить старую логику kill_processes
  - [~] 9.3.3 Документировать новый подход

### 10. Рефакторинг монолитного bot.py

- [~] 10.1 Создать структуру модулей
  - [~] 10.1.1 Создать директории bot/commands/
  - [~] 10.1.2 Создать файлы для групп команд
  - [~] 10.1.3 Создать router.py

- [~] 10.2 Разделить команды по модулям
  - [~] 10.2.1 Переместить admin команды
  - [~] 10.2.2 Переместить user команды
  - [~] 10.2.3 Переместить shop команды
  - [~] 10.2.4 Переместить game команды
  - [~] 10.2.5 Переместить system команды

- [~] 10.3 Создать систему регистрации команд
  - [~] 10.3.1 Реализовать router
  - [~] 10.3.2 Обновить main.py
  - [~] 10.3.3 Протестировать все команды

- [~] 10.4 Обновить тесты
  - [~] 10.4.1 Обновить импорты в тестах
  - [~] 10.4.2 Проверить все тесты
  - [~] 10.4.3 Добавить новые тесты при необходимости

### 11. Разделение уровней абстракции

- [~] 11.1 Создать service layer
  - [~] 11.1.1 Создать `core/services/user_service.py`
  - [~] 11.1.2 Создать `core/services/transaction_service.py`
  - [~] 11.1.3 Создать `core/services/shop_service.py`
  - [~] 11.1.4 Написать unit тесты для сервисов

- [~] 11.2 Вынести бизнес-логику из handlers
  - [~] 11.2.1 Рефакторить user commands
  - [~] 11.2.2 Рефакторить shop commands
  - [~] 11.2.3 Рефакторить admin commands

- [~] 11.3 Настроить dependency injection
  - [~] 11.3.1 Выбрать DI framework (или manual)
  - [~] 11.3.2 Настроить контейнер зависимостей
  - [~] 11.3.3 Обновить handlers для использования DI

- [~] 11.4 Обновить тесты
  - [~] 11.4.1 Добавить моки для сервисов
  - [~] 11.4.2 Проверить изоляцию тестов
  - [~] 11.4.3 Добавить integration тесты

### 12. Упрощение системы парсинга

- [~] 12.1 Создать ParserRegistry
  - [~] 12.1.1 Создать `core/parsers/registry.py`
  - [~] 12.1.2 Реализовать регистрацию парсеров
  - [~] 12.1.3 Написать тесты

- [~] 12.2 Зарегистрировать все парсеры
  - [~] 12.2.1 Обновить gdcards.py
  - [~] 12.2.2 Обновить shmalala.py
  - [~] 12.2.3 Обновить bunkerrp.py
  - [~] 12.2.4 Обновить truemafia.py

- [~] 12.3 Удалить дублирующие парсеры
  - [~] 12.3.1 Идентифицировать дубликаты
  - [~] 12.3.2 Выбрать основной парсер для каждой игры
  - [~] 12.3.3 Удалить или пометить deprecated

- [~] 12.4 Документировать систему парсинга
  - [~] 12.4.1 Создать PARSER_GUIDE.md
  - [~] 12.4.2 Добавить примеры создания парсера
  - [~] 12.4.3 Обновить README

### 13. Очистка неиспользуемого кода

- [~] 13.1 Аудит D&D системы
  - [~] 13.1.1 Проверить использование в коде
  - [~] 13.1.2 Решить: документировать или удалить
  - [~] 13.1.3 Выполнить решение

- [~] 13.2 Аудит системы кланов
  - [~] 13.2.1 Проверить использование
  - [~] 13.2.2 Решить: реализовать или удалить
  - [~] 13.2.3 Выполнить решение

- [~] 13.3 Аудит таблиц БД
  - [~] 13.3.1 Найти неиспользуемые таблицы
  - [~] 13.3.2 Документировать или создать миграцию удаления
  - [~] 13.3.3 Обновить схему БД

- [~] 13.4 Создать список deprecated функций
  - [~] 13.4.1 Найти все deprecated функции
  - [~] 13.4.2 Создать DEPRECATION.md с датами удаления
  - [~] 13.4.3 Добавить в CI проверку на устаревший код

## Фаза 3: Безопасность и качество (Приоритет 3) - Недели 6-8

### 14. Устранение race conditions

- [~] 14.1 Создать TransactionService с locks
  - [~] 14.1.1 Создать `core/services/transaction_service.py`
  - [~] 14.1.2 Реализовать lock management
  - [~] 14.1.3 Написать тесты

- [~] 14.2 Обновить все операции с балансом
  - [~] 14.2.1 Использовать TransactionService
  - [~] 14.2.2 Проверить все критические секции
  - [~] 14.2.3 Добавить тесты на конкурентность

- [~] 14.3 Настроить connection pooling
  - [~] 14.3.1 Настроить SQLAlchemy pool
  - [~] 14.3.2 Протестировать под нагрузкой
  - [~] 14.3.3 Документировать настройки

### 15. Защита от SQL injection

- [~] 15.1 Аудит всех SQL запросов
  - [~] 15.1.1 Найти все места с SQL
  - [~] 15.1.2 Проверить параметризацию
  - [~] 15.1.3 Исправить уязвимости

- [~] 15.2 Добавить линтер правила
  - [~] 15.2.1 Настроить bandit или similar
  - [~] 15.2.2 Добавить в CI
  - [~] 15.2.3 Исправить все warnings

- [~] 15.3 Добавить тесты на SQL injection
  - [~] 15.3.1 Создать `tests/security/test_sql_injection.py`
  - [~] 15.3.2 Написать property-based тесты
  - [~] 15.3.3 Проверить все входные точки

### 16. Улучшение идентификации пользователей

- [~] 16.1 Создать AliasService
  - [~] 16.1.1 Создать `core/services/alias_service.py`
  - [~] 16.1.2 Реализовать управление алиасами
  - [~] 16.1.3 Написать тесты

- [~] 16.2 Обновить парсеры для использования алиасов
  - [~] 16.2.1 Обновить логику поиска пользователей
  - [~] 16.2.2 Добавить fallback на имя
  - [~] 16.2.3 Протестировать все парсеры

- [~] 16.3 Добавить команду управления алиасами
  - [~] 16.3.1 Создать `/alias add <nickname>`
  - [~] 16.3.2 Создать `/alias list`
  - [~] 16.3.3 Создать `/alias remove <nickname>`
  - [~] 16.3.4 Написать тесты

### 17. Обеспечение атомарности транзакций

- [~] 17.1 Создать Unit of Work
  - [~] 17.1.1 Создать `src/repository/unit_of_work.py`
  - [~] 17.1.2 Реализовать context manager
  - [~] 17.1.3 Написать тесты

- [~] 17.2 Обновить все операции с транзакциями
  - [~] 17.2.1 Обернуть операции с балансом
  - [~] 17.2.2 Обернуть операции покупок
  - [~] 17.2.3 Проверить rollback при ошибках

- [~] 17.3 Добавить property-based тесты
  - [~] 17.3.1 Тест атомарности при ошибках
  - [~] 17.3.2 Тест консистентности данных
  - [~] 17.3.3 Тест конкурентных транзакций

### 18. Обновление документации

- [~] 18.1 Обновить README.md
  - [~] 18.1.1 Удалить описания нереализованных функций
  - [~] 18.1.2 Добавить актуальный список команд
  - [~] 18.1.3 Обновить инструкции по установке
  - [~] 18.1.4 Добавить раздел Environment Variables

- [~] 18.2 Создать архитектурную диаграмму
  - [~] 18.2.1 Создать диаграмму слоев
  - [~] 18.2.2 Создать диаграмму компонентов
  - [~] 18.2.3 Добавить в docs/

- [~] 18.3 Документировать процесс развертывания
  - [~] 18.3.1 Создать DEPLOYMENT.md
  - [~] 18.3.2 Добавить инструкции для разных окружений
  - [~] 18.3.3 Документировать миграции БД

### 19. Добавление API документации

- [~] 19.1 Добавить docstrings
  - [~] 19.1.1 Добавить в все публичные методы
  - [~] 19.1.2 Следовать Google style
  - [~] 19.1.3 Добавить примеры использования

- [~] 19.2 Настроить Sphinx
  - [~] 19.2.1 Установить Sphinx
  - [~] 19.2.2 Создать конфигурацию
  - [~] 19.2.3 Настроить autodoc

- [~] 19.3 Сгенерировать документацию
  - [~] 19.3.1 Запустить Sphinx
  - [~] 19.3.2 Проверить результат
  - [~] 19.3.3 Добавить в CI для автогенерации

- [~] 19.4 Создать руководство по интеграции парсеров
  - [~] 19.4.1 Документировать интерфейс BaseParser
  - [~] 19.4.2 Добавить примеры
  - [~] 19.4.3 Создать PARSER_API.md

### 20. Интеграционные тесты

- [~] 20.1 Создать E2E тесты для основных сценариев
  - [~] 20.1.1 Тест: регистрация пользователя
  - [~] 20.1.2 Тест: начисление очков
  - [~] 20.1.3 Тест: покупка в магазине
  - [~] 20.1.4 Тест: полный цикл пользователя

- [~] 20.2 Тесты интеграции парсеров
  - [~] 20.2.1 Тест каждого парсера с реальными данными
  - [~] 20.2.2 Тест обработки ошибок парсинга
  - [~] 20.2.3 Тест начисления очков после парсинга

- [~] 20.3 Тесты graceful shutdown
  - [~] 20.3.1 Тест обработки SIGTERM
  - [~] 20.3.2 Тест закрытия соединений
  - [~] 20.3.3 Тест завершения фоновых задач

- [~] 20.4 Измерить и улучшить coverage
  - [~] 20.4.1 Запустить coverage report
  - [~] 20.4.2 Идентифицировать некрытые участки
  - [~] 20.4.3 Добавить тесты до 90% coverage

## Финальная проверка

- [~] 21. Финальная валидация
  - [~] 21.1 Запустить все тесты (784+)
  - [~] 21.2 Проверить coverage (>80%)
  - [~] 21.3 Запустить линтеры (0 критических warnings)
  - [~] 21.4 Проверить время запуска (<5 сек)
  - [~] 21.5 Проверить документацию (100% публичных API)
  - [~] 21.6 Провести code review всех изменений
  - [~] 21.7 Протестировать в production-like окружении
  - [~] 21.8 Создать release notes
