# Спецификация: Исправление критических проблем проекта

## Обзор

Комплексный рефакторинг Telegram-бота банк-аггрегатора LucasTeam для устранения критических проблем в архитектуре, безопасности, конфигурации и тестировании.

## Цели

1. Устранить все критические проблемы безопасности и конфигурации
2. Унифицировать архитектуру и устранить дублирование кода
3. Исправить все ошибки импорта и зависимостей
4. Обеспечить стабильность и готовность к production

## Пользовательские истории и критерии приемки

### 1. Унификация конфигурации

**Как разработчик**, я хочу иметь единую точку конфигурации, чтобы избежать конфликтов и непредсказуемого поведения.

**Критерии приемки:**
- 1.1 Существует только один файл `src/config.py` с классом Settings
- 1.2 Все дубликаты `config.py` удалены из `utils/config.py` и `utils/core/config.py`
- 1.3 Все импорты обновлены и указывают на `src.config`
- 1.4 Конфигурация поддерживает окружения (development, test, production)
- 1.5 Все тесты проходят с новой системой конфигурации

### 2. Вынос конфиденциальных данных

**Как администратор системы**, я хочу управлять конфиденциальными данными через переменные окружения, чтобы обеспечить безопасность и гибкость развертывания.

**Критерии приемки:**
- 2.1 Telegram ID администратора вынесен в переменную окружения `ADMIN_TELEGRAM_ID`
- 2.2 Все 20+ мест с хардкодом ID обновлены для чтения из конфигурации
- 2.3 Файл `.env.example` содержит все необходимые переменные с описанием
- 2.4 Добавлена валидация обязательных переменных при старте приложения
- 2.5 Документация обновлена с инструкциями по настройке окружения

### 3. Исправление зависимостей

**Как разработчик**, я хочу иметь корректный файл зависимостей, чтобы проект можно было развернуть на любой машине.

**Критерии приемки:**
- 3.1 Корневой `requirements.txt` содержит все production зависимости
- 3.2 Создан отдельный `requirements-dev.txt` для тестовых библиотек
- 3.3 Все зависимости имеют закрепленные версии
- 3.4 Проект устанавливается и запускается в чистом виртуальном окружении
- 3.5 CI/CD pipeline использует правильные файлы зависимостей

### 4. Исправление импортов в тестах

**Как разработчик**, я хочу, чтобы все тесты загружались без ошибок, чтобы обеспечить надежность тестирования.

**Критерии приемки:**
- 4.1 Все 7 проблемных тестовых модулей успешно импортируются
- 4.2 Устаревшие импорты `utils.admin_system` заменены на `utils.admin.admin_system`
- 4.3 Устаревшие импорты `utils.simple_db` заменены на `utils.database.simple_db`
- 4.4 Импорт `register_user` исправлен с указанием правильного модуля
- 4.5 Команда `pytest --collect-only` выполняется без ошибок

### 5. Унификация работы с базой данных

**Как разработчик**, я хочу использовать единую систему работы с БД, чтобы избежать дублирования и несогласованности данных.

**Критерии приемки:**
- 5.1 Выбрана SQLAlchemy как основная ORM система
- 5.2 Все прямые SQL-запросы мигрированы на SQLAlchemy модели
- 5.3 Создан единый репозиторий для работы с пользователями
- 5.4 Устаревший `simple_db.py` помечен как deprecated с планом удаления
- 5.5 Все тесты обновлены для использования новой системы

### 6. Улучшение обработки ошибок

**Как пользователь бота**, я хочу получать понятные сообщения об ошибках, чтобы понимать, что пошло не так.

**Критерии приемки:**
- 6.1 Глобальный обработчик ошибок отправляет пользователю дружественное сообщение
- 6.2 Критические ошибки логируются с полным стектрейсом
- 6.3 Администраторы получают уведомления о критических ошибках
- 6.4 Ошибки не подавляются молча - всегда есть обратная связь
- 6.5 Добавлены тесты для различных сценариев ошибок

### 7. Унификация конфигурации парсинга

**Как разработчик**, я хочу иметь единый источник истины для конфигурации парсинга, чтобы избежать конфликтов.

**Критерии приемки:**
- 7.1 Выбран единый источник конфигурации (рекомендуется база данных)
- 7.2 Коэффициенты из `coefficients.json` мигрированы в БД
- 7.3 `ADVANCED_CURRENCY_CONFIG` из `config.py` удален или синхронизирован с БД
- 7.4 Создан API для управления правилами парсинга
- 7.5 Документирован процесс добавления новых правил

### 8. Валидация окружения

**Как администратор**, я хочу получать четкие ошибки при неправильной конфигурации, чтобы быстро исправить проблемы.

**Критерии приемки:**
- 8.1 При старте проверяется существование `.env` файла
- 8.2 Все обязательные переменные валидируются (BOT_TOKEN, DATABASE_URL, etc.)
- 8.3 Для необязательных переменных установлены разумные значения по умолчанию
- 8.4 Приложение не запускается с невалидной конфигурацией
- 8.5 Сообщения об ошибках конфигурации понятны и содержат инструкции

### 9. Безопасное завершение процессов

**Как администратор**, я хочу безопасно перезапускать бота, не затрагивая другие процессы.

**Критерии приемки:**
- 9.1 Функция `kill_existing_bot_processes()` использует PID-файл вместо имени процесса
- 9.2 При старте бота создается PID-файл с идентификатором процесса
- 9.3 Graceful shutdown корректно закрывает все соединения и задачи
- 9.4 Добавлена обработка сигналов SIGTERM и SIGINT
- 9.5 Тесты проверяют корректность завершения

### 10. Рефакторинг монолитного bot.py

**Как разработчик**, я хочу иметь модульную структуру команд, чтобы легко добавлять и поддерживать функциональность.

**Критерии приемки:**
- 10.1 Файл `bot.py` разбит на логические модули (не более 500 строк на файл)
- 10.2 Команды сгруппированы по функциональности (admin, shop, games, etc.)
- 10.3 Каждая группа команд в отдельном файле в `bot/commands/`
- 10.4 Создан роутер для регистрации всех обработчиков
- 10.5 Все тесты обновлены и проходят

### 11. Разделение уровней абстракции

**Как разработчик**, я хочу иметь четкое разделение между слоями приложения, чтобы упростить тестирование и поддержку.

**Критерии приемки:**
- 11.1 Telegram-обработчики не содержат бизнес-логику
- 11.2 Вся бизнес-логика вынесена в сервисные классы
- 11.3 Сервисы не зависят от Telegram API
- 11.4 Создан слой репозиториев для работы с БД
- 11.5 Зависимости инжектируются через конструкторы

### 12. Упрощение системы парсинга

**Как разработчик**, я хочу понимать, какой парсер используется для каждой игры, чтобы легко добавлять новые парсеры.

**Критерии приемки:**
- 12.1 Создан единый реестр парсеров с явной регистрацией
- 12.2 Каждая игра имеет один основной парсер
- 12.3 Дублирующие парсеры удалены или помечены как deprecated
- 12.4 Документирован процесс добавления нового парсера
- 12.5 Тесты покрывают все активные парсеры

### 13. Очистка неиспользуемого кода

**Как разработчик**, я хочу иметь чистую кодовую базу без мертвого кода, чтобы упростить навигацию и поддержку.

**Критерии приемки:**
- 13.1 D&D система либо документирована, либо удалена
- 13.2 Система кланов либо реализована с командами, либо удалена
- 13.3 Неиспользуемые таблицы БД удалены или документированы
- 13.4 Все импорты проверены на использование
- 13.5 Создан список deprecated функций с датами удаления

### 14. Устранение race conditions

**Как разработчик**, я хочу гарантировать потокобезопасность фоновых задач, чтобы избежать повреждения данных.

**Критерии приемки:**
- 14.1 Все критические секции защищены asyncio.Lock
- 14.2 Операции с БД выполняются в транзакциях
- 14.3 Добавлены тесты для проверки конкурентного доступа
- 14.4 Документированы все точки синхронизации
- 14.5 Используется connection pooling для БД

### 15. Защита от SQL injection

**Как разработчик**, я хочу гарантировать отсутствие SQL injection уязвимостей, чтобы обеспечить безопасность данных.

**Критерии приемки:**
- 15.1 Все SQL-запросы используют параметризованные запросы
- 15.2 Прямая конкатенация SQL запрещена линтером
- 15.3 Добавлены тесты на SQL injection
- 15.4 Проведен аудит всех мест работы с БД
- 15.5 Документированы best practices для работы с БД

### 16. Улучшение идентификации пользователей

**Как система**, я хочу надежно связывать игровые ники с Telegram ID, чтобы корректно начислять очки.

**Критерии приемки:**
- 16.1 Таблица `user_aliases` активно используется для связи ников и ID
- 16.2 Парсеры сначала ищут пользователя по алиасу, затем по имени
- 16.3 Добавлена команда для управления алиасами пользователя
- 16.4 При неоднозначности система запрашивает подтверждение
- 16.5 Тесты покрывают все сценарии идентификации

### 17. Обеспечение атомарности транзакций

**Как система**, я хочу гарантировать, что изменение баланса и запись в историю происходят атомарно, чтобы избежать несогласованности данных.

**Критерии приемки:**
- 17.1 Все операции с балансом обернуты в транзакции БД
- 17.2 При ошибке записи в историю откатывается изменение баланса
- 17.3 Добавлены тесты для проверки атомарности
- 17.4 Используется паттерн Unit of Work
- 17.5 Логируются все транзакционные операции

### 18. Обновление документации

**Как новый разработчик**, я хочу иметь актуальную документацию, чтобы быстро разобраться в проекте.

**Критерии приемки:**
- 18.1 README.md соответствует текущему состоянию проекта
- 18.2 Все реализованные команды документированы
- 18.3 Удалены описания нереализованных функций
- 18.4 Добавлена архитектурная диаграмма
- 18.5 Документирован процесс развертывания

### 19. Добавление API документации

**Как разработчик**, я хочу иметь документацию внутренних API, чтобы понимать, как использовать модули.

**Критерии приемки:**
- 19.1 Все публичные методы имеют docstrings
- 19.2 Docstrings следуют Google/NumPy стилю
- 19.3 Сгенерирована API документация с помощью Sphinx
- 19.4 Документированы все интерфейсы для интеграции парсеров
- 19.5 Примеры использования для ключевых компонентов

### 20. Интеграционные тесты

**Как разработчик**, я хочу иметь интеграционные тесты для критических путей, чтобы гарантировать работоспособность системы.

**Критерии приемки:**
- 20.1 Добавлены E2E тесты для основных пользовательских сценариев
- 20.2 Тесты покрывают полный цикл: регистрация → начисление → покупка
- 20.3 Тесты проверяют интеграцию всех парсеров
- 20.4 Добавлены тесты для graceful shutdown
- 20.5 Coverage критических путей не менее 90%

## Приоритизация

### Приоритет 1 (Критично) - Недели 1-2
- Требования 1-4: Конфигурация, безопасность, зависимости, импорты

### Приоритет 2 (Важно) - Недели 3-5
- Требования 5-13: Архитектура, обработка ошибок, рефакторинг

### Приоритет 3 (Желательно) - Недели 6-8
- Требования 14-20: Безопасность, документация, тестирование

## Ограничения и допущения

1. Проект должен оставаться работоспособным на всех этапах рефакторинга
2. Все существующие тесты должны продолжать проходить
3. Миграция выполняется постепенно с сохранением обратной совместимости
4. Критические изменения требуют code review
5. Каждое требование реализуется в отдельной ветке с PR

## Метрики успеха

1. Все 784 теста проходят успешно
2. Coverage кода не менее 80%
3. Нет критических предупреждений от линтеров
4. Время запуска бота < 5 секунд
5. Документация покрывает 100% публичных API
