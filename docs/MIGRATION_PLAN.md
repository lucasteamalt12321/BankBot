# План миграции на новую систему парсинга

**Дата:** 14 февраля 2026  
**Статус:** В разработке  
**Приоритет:** Критический

---

## Обзор

Этот документ описывает пошаговый план миграции с текущей системы парсинга (`core/parsers/simple_parser.py` + `bot/bot.py`) на новую модульную систему (`src/parsers.py` + `src/message_processor.py`), которая уже частично реализована и имеет полный spec в `.kiro/specs/message-parsing-system/`.

## Текущее состояние

### Что работает (старая система)
- ✅ GD Cards: профили и начисления орбов
- ✅ Shmalala: рыбалка
- ✅ Ручной парсинг по команде "парсинг"

### Что НЕ работает (но код есть)
- ❌ True Mafia: парсеры написаны в `src/`, но не интегрированы
- ❌ Bunker RP: парсеры написаны в `src/`, но не интегрированы
- ❌ Система дельт для профилей: таблица `bot_balances` создана, логика не работает
- ❌ Shmalala Karma: парсер есть, не интегрирован

### Проблемы
1. **Дублирование кода**: две системы парсинга
2. **Неполная функциональность**: заявленные игры не работают
3. **Отсутствие дельт**: профили бесполезны
4. **Монолитность**: вся логика в `bot/bot.py`

---

## Стратегия миграции

### Подход: Постепенная замена с тестированием

Мы НЕ будем переписывать всё сразу. Вместо этого:
1. Завершим реализацию новой системы (spec уже есть)
2. Протестируем новую систему изолированно
3. Создадим адаптер для интеграции с ботом
4. Постепенно переключим игры одну за другой
5. Удалим старый код после полной миграции

---

## Фазы миграции

### Фаза 0: Подготовка (1-2 дня)

**Цель:** Завершить реализацию новой системы согласно spec

#### Задачи:
- [ ] 0.1 Завершить реализацию `BalanceManager` (задачи 9.1-9.10 из spec)
- [ ] 0.2 Реализовать `IdempotencyChecker` (задачи 10.1-10.3)
- [ ] 0.3 Реализовать `AuditLogger` (задачи 11.1-11.3)
- [ ] 0.4 Реализовать `MessageProcessor` (задачи 12.1-12.5)
- [ ] 0.5 Написать интеграционные тесты (задачи 13.1-13.12)
- [ ] 0.6 Запустить все тесты и убедиться, что они проходят

**Критерий завершения:** Все тесты из spec проходят (unit + property + integration)

---

### Фаза 1: Создание адаптера (2-3 дня)

**Цель:** Создать мост между ботом и новой системой

#### Задачи:
- [ ] 1.1 Создать `bot/adapters/parsing_adapter.py`
  - Класс `ParsingAdapter` с методом `process_message(message_text, message_id)`
  - Инициализация всех компонентов новой системы
  - Преобразование результатов в формат, понятный боту
  
- [ ] 1.2 Создать фабрику для инициализации системы
  ```python
  # bot/adapters/parsing_factory.py
  class ParsingSystemFactory:
      @staticmethod
      def create() -> MessageProcessor:
          # Инициализация всех компонентов
          pass
  ```

- [ ] 1.3 Добавить конфигурацию
  - Убедиться, что `config/coefficients.json` актуален
  - Добавить настройки в `config/bot_config.yaml` для переключения систем

- [ ] 1.4 Написать тесты для адаптера
  - Unit-тесты для `ParsingAdapter`
  - Интеграционные тесты с реальными сообщениями

**Критерий завершения:** Адаптер работает и протестирован

---

### Фаза 2: Параллельный запуск (3-5 дней)

**Цель:** Запустить обе системы параллельно для сравнения результатов

#### Задачи:
- [ ] 2.1 Добавить флаг `USE_NEW_PARSER` в конфигурацию
  
- [ ] 2.2 Модифицировать `bot/bot.py`:
  ```python
  async def handle_manual_parsing(self, update, context):
      if config.USE_NEW_PARSER:
          # Новая система
          result = await self.parsing_adapter.process_message(...)
      else:
          # Старая система (текущий код)
          result = await self.old_parsing_logic(...)
  ```

- [ ] 2.3 Добавить режим "dual mode" для сравнения:
  ```python
  if config.DUAL_MODE:
      old_result = await self.old_parsing_logic(...)
      new_result = await self.parsing_adapter.process_message(...)
      self.compare_results(old_result, new_result)
  ```

- [ ] 2.4 Логировать расхождения между системами

- [ ] 2.5 Тестировать на реальных сообщениях в течение 2-3 дней

**Критерий завершения:** Обе системы дают одинаковые результаты для GD Cards и Shmalala

---

### Фаза 3: Миграция по играм (5-7 дней)

**Цель:** Постепенно переключить каждую игру на новую систему

#### 3.1 GD Cards (1-2 дня)
- [ ] Переключить GD Cards на новую систему
- [ ] Тестировать профили и начисления
- [ ] Убедиться, что дельты работают корректно
- [ ] Мониторить ошибки 24 часа

#### 3.2 Shmalala Fishing (1 день)
- [ ] Переключить Shmalala Fishing на новую систему
- [ ] Тестировать начисления
- [ ] Мониторить ошибки 24 часа

#### 3.3 Shmalala Karma (1 день)
- [ ] Включить Shmalala Karma (новая функциональность!)
- [ ] Тестировать начисления (+1 karma = +10 coins)
- [ ] Мониторить ошибки 24 часа

#### 3.4 True Mafia (1-2 дня)
- [ ] Включить True Mafia (новая функциональность!)
- [ ] Тестировать профили с дельтами
- [ ] Тестировать окончания игр (10 money на победителя)
- [ ] Мониторить ошибки 24 часа

#### 3.5 Bunker RP (1-2 дня)
- [ ] Включить Bunker RP (новая функциональность!)
- [ ] Тестировать профили с дельтами
- [ ] Тестировать окончания игр (30 money на победителя)
- [ ] Мониторить ошибки 24 часа

**Критерий завершения:** Все 5 игр работают на новой системе без ошибок

---

### Фаза 4: Очистка кода (2-3 дня)

**Цель:** Удалить старый код и дубликаты

#### Задачи:
- [ ] 4.1 Удалить старую систему парсинга
  - `core/parsers/simple_parser.py` → удалить
  - Старые методы из `bot/bot.py` → удалить
  - `bot/handlers/parsing_handler.py` → удалить или переписать

- [ ] 4.2 Переместить новую систему из `src/` в `core/`
  ```
  src/parsers.py → core/parsers/parsers.py
  src/message_processor.py → core/processors/message_processor.py
  src/balance_manager.py → core/managers/balance_manager.py
  src/repository.py → core/database/repository.py
  src/classifier.py → core/parsers/classifier.py
  src/coefficient_provider.py → core/managers/coefficient_provider.py
  src/idempotency.py → core/utils/idempotency.py
  src/audit_logger.py → core/utils/audit_logger.py
  ```

- [ ] 4.3 Обновить импорты во всём проекте

- [ ] 4.4 Удалить неиспользуемые файлы из `src/`

- [ ] 4.5 Обновить документацию
  - `docs/guides/parsing_system_guide.md`
  - `docs/guides/message_parser_system.md`
  - `docs/README.md`

- [ ] 4.6 Запустить все тесты после рефакторинга

**Критерий завершения:** Старый код удалён, новый код в правильных местах, все тесты проходят

---

### Фаза 5: Оптимизация и мониторинг (1-2 дня)

**Цель:** Убедиться, что система работает эффективно

#### Задачи:
- [ ] 5.1 Добавить метрики производительности
  - Время парсинга на сообщение
  - Количество обработанных сообщений
  - Количество ошибок парсинга

- [ ] 5.2 Оптимизировать запросы к БД
  - Добавить индексы на `bot_balances(user_id, game)`
  - Проверить N+1 запросы

- [ ] 5.3 Настроить алерты
  - Алерт при высоком проценте ошибок парсинга
  - Алерт при падении производительности

- [ ] 5.4 Создать дашборд для мониторинга
  - Статистика по играм
  - Топ пользователей по начислениям
  - График ошибок

**Критерий завершения:** Система мониторится, метрики собираются

---

## Риски и митигация

### Риск 1: Потеря данных при миграции
**Вероятность:** Средняя  
**Влияние:** Критическое  
**Митигация:**
- Создать полный бэкап БД перед каждой фазой
- Использовать транзакции для всех операций
- Тестировать на копии продакшн БД

### Риск 2: Расхождения в логике между системами
**Вероятность:** Высокая  
**Влияние:** Среднее  
**Митигация:**
- Фаза 2 (параллельный запуск) выявит расхождения
- Логировать все расхождения для анализа
- Исправить логику до полной миграции

### Риск 3: Производительность новой системы
**Вероятность:** Низкая  
**Влияние:** Среднее  
**Митигация:**
- Бенчмарки на этапе разработки
- Мониторинг производительности в Фазе 2
- Оптимизация в Фазе 5

### Риск 4: Баги в новой системе
**Вероятность:** Средняя  
**Влияние:** Высокое  
**Митигация:**
- Полное покрытие тестами (unit + property + integration)
- Постепенная миграция по играм
- Возможность быстрого отката на старую систему

---

## Критерии успеха

### Технические
- ✅ Все 5 игр работают на новой системе
- ✅ Система дельт работает для всех профилей
- ✅ Все тесты проходят (100%)
- ✅ Нет дублирования кода
- ✅ Производительность не хуже старой системы

### Функциональные
- ✅ True Mafia полностью интегрирована
- ✅ Bunker RP полностью интегрирована
- ✅ Shmalala Karma работает
- ✅ Профили всех игр отслеживают дельты
- ✅ Пользователи получают корректные начисления

### Качество кода
- ✅ Код в правильных директориях
- ✅ Документация обновлена
- ✅ Нет неиспользуемого кода
- ✅ Архитектура чистая и понятная

---

## Откат (Rollback Plan)

Если что-то пойдёт не так на любой фазе:

### Быстрый откат (< 5 минут)
1. Установить `USE_NEW_PARSER = False` в конфигурации
2. Перезапустить бота
3. Старая система продолжит работать

### Полный откат (< 30 минут)
1. Восстановить БД из бэкапа
2. Откатить код на предыдущий коммит
3. Перезапустить бота
4. Проверить работоспособность

---

## Расписание

| Фаза | Длительность | Начало | Окончание |
|------|--------------|--------|-----------|
| Фаза 0: Подготовка | 1-2 дня | День 1 | День 2 |
| Фаза 1: Адаптер | 2-3 дня | День 3 | День 5 |
| Фаза 2: Параллельный запуск | 3-5 дней | День 6 | День 10 |
| Фаза 3: Миграция по играм | 5-7 дней | День 11 | День 17 |
| Фаза 4: Очистка кода | 2-3 дня | День 18 | День 20 |
| Фаза 5: Оптимизация | 1-2 дня | День 21 | День 22 |

**Общая длительность:** 14-22 дня (3-4 недели)

---

## Следующие шаги

1. **Немедленно:** Завершить Фазу 0 (реализация по spec)
2. **На этой неделе:** Создать адаптер (Фаза 1)
3. **На следующей неделе:** Запустить параллельно (Фаза 2)
4. **Через 2 недели:** Начать миграцию игр (Фаза 3)

---

## Контакты и ответственные

- **Разработка:** Kiro AI + LucasTeam
- **Тестирование:** LucasTeam
- **Утверждение:** @LucasTeamLuke

---

**Статус:** Готов к началу Фазы 0
