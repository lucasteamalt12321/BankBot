# Визуальная структура проекта

## 🎯 Основной поток работы

```
┌─────────────────────────────────────────────────────────────┐
│                      ПОЛЬЗОВАТЕЛЬ                            │
│                    (Telegram клиент)                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    run_bot.py                                │
│                  (Точка входа)                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   bot/bot.py                                 │
│              (Главная логика бота)                           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  parse_all_messages()                                │   │
│  │  ↓                                                    │   │
│  │  Проверяет каждое сообщение через парсер             │   │
│  └──────────────────────────────────────────────────────┘   │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  core/parsers/simple_parser.py                       │   │
│  │  parse_game_message()                                │   │
│  │  ↓                                                    │   │
│  │  Распознает: 🎣 Рыбалка, 🃏 Карты                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  process_game_message()                              │   │
│  │  ↓                                                    │   │
│  │  Начисляет монеты/очки                               │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                  data/bot.db                                 │
│              (База данных SQLite)                            │
│                                                              │
│  Таблицы:                                                    │
│  • users (пользователи)                                      │
│  • transactions (транзакции)                                 │
│  • shop_items (товары)                                       │
│  • shop_categories (категории)                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 📂 Структура папок по назначению

```
BankBot/
│
├── 🚀 ЗАПУСК
│   ├── run_bot.py              # Точка входа
│   └── bot/main.py             # Инициализация
│
├── 🤖 БОТ (Telegram интерфейс)
│   ├── bot/bot.py              # Главная логика (3000+ строк)
│   ├── bot/commands/           # Команды (/admin, /shop, etc)
│   └── bot/parsers/            # Конфигурация парсеров
│
├── 🧠 ЛОГИКА (Бизнес-логика)
│   ├── core/parsers/           # 🆕 Парсинг игровых сообщений
│   ├── core/handlers/          # Обработчики (покупки, магазин)
│   ├── core/managers/          # Менеджеры (админ, задачи, стикеры)
│   ├── core/systems/           # Системы (достижения, игры, D&D)
│   └── core/models/            # Модели данных
│
├── 💾 ДАННЫЕ
│   ├── data/bot.db             # 🆕 Единая БД (объединенная)
│   ├── database/database.py    # Схема БД (SQLAlchemy)
│   └── database/migrations/    # Миграции
│
├── 🔧 УТИЛИТЫ
│   ├── utils/admin/            # Админ-система
│   ├── utils/core/             # Основные утилиты
│   ├── utils/database/         # Утилиты БД
│   └── utils/monitoring/       # Мониторинг
│
├── ⚙️ КОНФИГУРАЦИЯ
│   ├── config/.env             # Токен бота (создать!)
│   ├── config/requirements.txt # Зависимости
│   └── config/bot_config.yaml  # Настройки
│
├── 🧪 ТЕСТЫ
│   ├── tests/unit/             # Unit-тесты (20+ файлов)
│   ├── tests/integration/      # Интеграционные (15+ файлов)
│   └── tests/property/         # Property-based (15+ файлов)
│
├── 📚 ДОКУМЕНТАЦИЯ
│   ├── docs/README.md          # Общая документация
│   ├── docs/PARSER_*.md        # 🆕 Документация парсера
│   ├── docs/DATABASE_*.md      # 🆕 Документация БД
│   └── docs/PROJECT_*.md       # 🆕 Карта проекта
│
├── 📝 ПРИМЕРЫ
│   └── examples/               # Примеры использования
│
└── 🛠️ СКРИПТЫ
    ├── scripts/                # Вспомогательные скрипты
    └── database/               # Скрипты БД
```

---

## 🔄 Поток обработки команды

```
Пользователь отправляет: /shop
         │
         ▼
┌─────────────────────┐
│   bot/bot.py        │
│   shop_command()    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ core/systems/       │
│ shop_system.py      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ core/database/      │
│ shop_database.py    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   data/bot.db       │
│   (SQLite)          │
└──────────┬──────────┘
           │
           ▼
    Ответ пользователю
```

---

## 🎮 Поток парсинга игрового сообщения

```
Игровой бот отправляет:
🎣 [Рыбалка] 🎣
Рыбак: @username
Монеты: +250 (1500)💰
         │
         ▼
┌─────────────────────────────────┐
│   bot/bot.py                    │
│   parse_all_messages()          │
│   ↓                              │
│   Получает сообщение             │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│   core/parsers/simple_parser.py │
│   parse_game_message()          │
│   ↓                              │
│   Распознает тип: 'fishing'     │
│   Извлекает: @username, 250     │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│   bot/bot.py                    │
│   process_game_message()        │
│   ↓                              │
│   1. Находит пользователя       │
│   2. Начисляет 250 монет        │
│   3. Сохраняет в БД             │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│   data/bot.db                   │
│   UPDATE users                  │
│   SET balance = balance + 250   │
└──────────┬──────────────────────┘
           │
           ▼
    Уведомление в чат:
    🎣 username поймал рыбу!
    💰 Начислено: 250 монет
```

---

## 🔐 Поток проверки прав администратора

```
Пользователь: /add_points @user 100
         │
         ▼
┌─────────────────────┐
│   bot/bot.py        │
│   @admin_required   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ utils/admin/        │
│ admin_system.py     │
│ is_admin(user_id)   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   data/bot.db       │
│   SELECT is_admin   │
│   FROM users        │
└──────────┬──────────┘
           │
           ├─── ✅ Админ → Выполнить команду
           │
           └─── ❌ Не админ → Отказать
```

---

## 📊 Зависимости между модулями

```
┌──────────────┐
│  run_bot.py  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  bot/bot.py  │◄─────────────────┐
└──────┬───────┘                  │
       │                          │
       ├──────────────────────────┤
       │                          │
       ▼                          │
┌──────────────┐          ┌───────────────┐
│ core/parsers │          │ bot/commands/ │
└──────┬───────┘          └───────┬───────┘
       │                          │
       ▼                          ▼
┌──────────────┐          ┌───────────────┐
│ core/systems │          │ utils/admin/  │
└──────┬───────┘          └───────┬───────┘
       │                          │
       ▼                          ▼
┌──────────────┐          ┌───────────────┐
│core/handlers │          │ utils/core/   │
└──────┬───────┘          └───────┬───────┘
       │                          │
       └──────────┬────────────────┘
                  │
                  ▼
          ┌───────────────┐
          │  data/bot.db  │
          └───────────────┘
```

---

## 🎯 Ключевые точки входа

### Для пользователя:
```
Telegram → bot/bot.py → Команды/Парсер → БД → Ответ
```

### Для разработчика:
```
1. Запуск: run_bot.py
2. Логика: bot/bot.py
3. Парсинг: core/parsers/simple_parser.py
4. БД: database/database.py
5. Тесты: tests/
```

### Для администратора:
```
1. Конфигурация: config/.env
2. БД: data/bot.db
3. Бэкапы: database/backup_system.py
4. Миграции: database/migrations/
```

---

## 📈 Масштабирование

```
Текущая архитектура:
┌─────────┐
│  Bot    │
└────┬────┘
     │
     ▼
┌─────────┐
│ SQLite  │
└─────────┘

Возможное расширение:
┌─────────┐     ┌─────────┐
│  Bot 1  │     │  Bot 2  │
└────┬────┘     └────┬────┘
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │  PostgreSQL   │
     └───────────────┘
```

---

## 🔍 Где искать что

| Нужно найти | Где искать |
|-------------|------------|
| **Команды бота** | `bot/bot.py` (функции с `async def`) |
| **Парсинг игр** | `core/parsers/simple_parser.py` |
| **Логика магазина** | `core/systems/shop_system.py` |
| **Работа с БД** | `database/database.py` |
| **Админ-права** | `utils/admin/admin_system.py` |
| **Конфигурация** | `config/` |
| **Тесты** | `tests/` |
| **Документация** | `docs/` |
| **Примеры** | `examples/` |

---

**Создано:** 2026-02-08  
**Версия:** 1.0  
**Статус:** ✅ Актуально
